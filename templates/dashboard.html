<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Screen</title>
    <link rel="icon" href="{{ url_for('static', filename='images/logo.ico') }}" type="image/x-icon">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
        }

        body { background-color: #f0f2f5; }

        /* Navigation Bar */
        .navbar {
            background-color: #0056b3;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .btn-logout {
            color: white;
            text-decoration: none;
            border: 1px solid white;
            padding: 5px 15px;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn-logout:hover { background-color: rgba(255,255,255,0.1); }

        /* Tab Container */
        .container {
            max-width: 900px;
            margin: 30px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: 400px;
        }

        /* Tabs Header */
        .tabs-header {
            display: flex;
            border-bottom: 1px solid #ddd;
            background: #f8f9fa;
        }
        .tab-link {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: 0.3s;
            border-bottom: 3px solid transparent;
        }
        .tab-link:hover { background: #e9ecef; }
        .tab-link.active {
            color: #0056b3;
            border-bottom: 3px solid #0056b3;
            background: white;
        }

        /* Tabs Content */
        .tab-content {
            display: none;
            padding: 30px;
        }
        .tab-content.active { display: block; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        .btn-action {
            background-color: #0056b3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
        }
        .btn-action:hover { background-color: #004494; }

        .error-msg {
            color: #dc3545;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        /* Transaction Table Styles */
        .trans-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .trans-table th { background-color: #f1f3f5; text-align: left; padding: 12px; border-bottom: 2px solid #ddd; color: #555; }
        .trans-table td { padding: 12px; border-bottom: 1px solid #eee; color: #333; }
        .trans-table tr:hover { background-color: #f8f9fa; }

        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .badge-debit { background-color: #ffe3e3; color: #c92a2a; }
        .badge-credit { background-color: #d3f9d8; color: #2b8a3e; }

    </style>
</head>
<body>
    <div class="navbar">
        <h1>Personal Banking Dashboard</h1>
        <a href="/logout" class="btn-logout">Logout</a>
    </div>

    <div class="container">
        <div class="tabs-header">
            <div class="tab-link active" onclick="openTab(event, 'tabAccount')">Account Information</div>
            <div class="tab-link" onclick="openTab(event, 'tabTransfer')">Transfer Funds</div>
            <div class="tab-link" onclick="openTab(event, 'tabHistory')">Transactions</div>
            <div class="tab-link" onclick="openTab(event, 'tabReset')">Reset Password</div>
        </div>

        <div id="tabAccount" class="tab-content active">
            <h2 id="welcomeMsg">Welcome, User</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 15px; border: 1px solid #e9ecef;">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="font-size:12px; color:#666; font-weight:bold; text-transform:uppercase;">Account Holder</label>
                        <div id="dispName" style="font-size:16px; font-weight:600;">-</div>
                    </div>
                    <div>
                        <label style="font-size:12px; color:#666; font-weight:bold; text-transform:uppercase;">Account Balance</label>
                        <div style="font-size:18px; font-weight:700; color:green;">₹ <span id="dispBalance">-</span></div>
                    </div>
                </div>

                <hr style="border: 0; border-top: 1px solid #ddd; margin: 15px 0;">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-size:12px; color:#666;">Account Number</label>
                        <div id="dispAccNum" style="font-weight:500;">-</div>
                    </div>
                    <div>
                        <label style="font-size:12px; color:#666;">IFSC Code</label>
                        <div id="dispIfsc" style="font-weight:500;">-</div>
                    </div>
                    <div>
                        <label style="font-size:12px; color:#666;">Bank Branch</label>
                        <div id="dispBranch" style="font-weight:500;">-</div>
                    </div>
                    <div>
                        <label style="font-size:12px; color:#666;">UPI ID</label>
                        <div id="dispUpi" style="font-weight:500;">-</div>
                    </div>
                    <div>
                        <label style="font-size:12px; color:#666;">User ID</label>
                        <div id="dispUserId" style="font-weight:500;">-</div>
                    </div>
                    <div>
                        <label style="font-size:12px; color:#666;">Email ID</label>
                        <div id="dispEmail" style="font-weight:500;">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tabTransfer" class="tab-content">
            <h2>Transfer Funds</h2>
            <div style="margin-bottom: 20px; color: #555;">
                Max Transferable Balance: <span style="font-weight: bold; color: green;">₹ <span id="maxTransferBalance">0.00</span></span>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-action" id="btnIMPS" onclick="setTransferMode('IMPS')" style="flex:1; background:#0056b3;">IMPS</button>
                <button class="btn-action" id="btnUPI" onclick="setTransferMode('UPI')" style="flex:1; background:#ccc; color: black;">UPI</button>
            </div>

            <div id="transferForm">

                <div class="form-group">
                    <label id="lblIdentifier">Account Number</label>
                    <input type="text" id="inputIdentifier" class="form-control" placeholder="Enter Account Number" onblur="verifyBeneficiary()">

                    <div id="fetchResult" style="font-size: 13px; margin-top: 5px; font-weight: 600; display: none;"></div>
                </div>

                <div class="form-group">
                    <label>Amount (₹)</label>
                    <input type="number" id="inputAmount" class="form-control" placeholder="0.00" step="0.01" min="1">
                </div>

                <div class="form-group">
                    <label>Reference Note</label>
                    <input type="text" id="inputNote" class="form-control" placeholder="Monthly Rent, Dinner Outing, etc.">
                </div>

                <button class="btn-action" onclick="submitTransfer()">Transfer Funds</button>
            </div>
        </div>

        <div id="tabHistory" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Transaction History</h2>
                <button class="btn-action" onclick="loadTransactions()" style="padding: 5px 10px; font-size: 12px;">Refresh</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="trans-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Mode</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Note</th>
                        </tr>
                    </thead>
                    <tbody id="transBody">
                        </tbody>
                </table>
                <p id="noTransMsg" style="display:none; text-align:center; margin-top:20px; color:#777;">No transactions found.</p>
            </div>
        </div>

        <div id="tabReset" class="tab-content">
            <h2>Change Password</h2>
            <p style="margin-bottom: 20px; color: #666; font-size: 14px;">Enter your new desired password below.</p>

            <p id="resultMessage" style="display:none; font-weight: bold; margin-bottom: 15px;"></p>

            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="newPass" class="form-control" placeholder="At least 8 characters">
                <div id="errNew" class="error-msg">Password must be at least 8 characters long.</div>
            </div>

            <button class="btn-action" onclick="submitPasswordReset()">Reset Password</button>
        </div>
    </div>

    <script>
        // GLOBAL VARIABLES
        let currentMode = 'IMPS';
        let currentBalance = 0.00; // Will be set by loadAccountInfo
        let isBeneficiaryValid = false;

        // Tab Switching Logic
        function openTab(evt, tabName) {
            let contents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < contents.length; i++) {
                contents[i].style.display = "none";
                contents[i].classList.remove("active");
            }
            let links = document.getElementsByClassName("tab-link");
            for (let i = 0; i < links.length; i++) {
                links[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
        }

        async function submitPasswordReset() {
            const newPass = document.getElementById('newPass').value;
            const errNew = document.getElementById('errNew');
            const resultMsg = document.getElementById('resultMessage');

            // Reset UI
            errNew.style.display = 'none';
            resultMsg.style.display = 'none';
            resultMsg.style.color = '#333';

            // Validation
            if (newPass.length < 8) {
                errNew.style.display = 'block';
                return;
            }

            // API Call
            try {
                const response = await fetch('/api/resetPassword', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_password: newPass })
                });

                const data = await response.json();

                // Show Result Message
                resultMsg.style.display = 'block';

                if (response.ok) {
                    resultMsg.innerText = "Password changed successfully";
                    resultMsg.style.color = "green";
                    document.getElementById('newPass').value = ""; // Clear input
                } else {
                    resultMsg.innerText = "Unable to reset your password";
                    resultMsg.style.color = "red";
                }
            } catch (e) {
                resultMsg.style.display = 'block';
                resultMsg.innerText = "Unable to reset your password";
                resultMsg.style.color = "red";
            }
        }

        // Load Account Info
        async function loadAccountInfo() {
            try {
                const response = await fetch('/api/get_account_information');
                const data = await response.json();

                if (response.ok) {
                    // Populate Fields
                    document.getElementById('welcomeMsg').innerText = "Hi, " + data.account_holder_name;
                    document.getElementById('dispName').innerText = data.account_holder_name;
                    document.getElementById('dispBalance').innerText = data.account_balance;
                    document.getElementById('dispAccNum').innerText = data.account_number;
                    document.getElementById('dispIfsc').innerText = data.ifsc_code;
                    document.getElementById('dispBranch').innerText = data.bank_branch;
                    document.getElementById('dispUpi').innerText = data.upi_id;
                    document.getElementById('dispUserId').innerText = data.userId;
                    document.getElementById('dispEmail').innerText = data.email_id;
                } else {
                    alert("Error loading data: " + data.error);
                }
            } catch (e) {
                console.error("Failed to fetch account info");
            }
        }
        // Call on page load
        window.onload = loadAccountInfo;

        // Hook into the existing loadAccountInfo to update the Transfer Tab balance
        const originalLoad = window.onload;
        window.onload = async function() {
            if(originalLoad) await originalLoad();

            // Update the Max Balance display in Transfer Tab
            const balText = document.getElementById('dispBalance').innerText;
            currentBalance = parseFloat(balText);
            document.getElementById('maxTransferBalance').innerText = balText;
        }

        // Toggle Logic: IMPS/UPI
        function setTransferMode(mode) {
            currentMode = mode;
            isBeneficiaryValid = false;

            // UI Updates
            document.getElementById('btnIMPS').style.background = mode === 'IMPS' ? '#0056b3' : '#ccc';
            document.getElementById('btnIMPS').style.color = mode === 'IMPS' ? 'white' : 'black';

            document.getElementById('btnUPI').style.background = mode === 'UPI' ? '#0056b3' : '#ccc';
            document.getElementById('btnUPI').style.color = mode === 'UPI' ? 'white' : 'black';

            // Reset Fields
            document.getElementById('inputIdentifier').value = '';
            document.getElementById('fetchResult').style.display = 'none';
            document.getElementById('inputIdentifier').placeholder = mode === 'IMPS' ? "Enter Account Number" : "Enter UPI ID";
            document.getElementById('lblIdentifier').innerText = mode === 'IMPS' ? "Account Number" : "UPI ID";
        }

        // Auto-Fetch Beneficiary Logic
        async function verifyBeneficiary() {
            const val = document.getElementById('inputIdentifier').value;
            const resBox = document.getElementById('fetchResult');

            if(val.length < 3) return; // Don't check empty

            resBox.style.display = 'block';
            resBox.style.color = 'orange';
            resBox.innerText = "Verifying...";

            try {
                const response = await fetch('/api/lookup_beneficiary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: currentMode, value: val })
                });
                const data = await response.json();

                if (data.valid) {
                    isBeneficiaryValid = true;
                    resBox.style.color = 'green';
                    if (currentMode === 'IMPS') {
                        resBox.innerText = "✓ Account Holder: " + data.name + "; Branch: " + data.branch;
                    } else {
                        resBox.innerText = "✓ " + data.name + "'s UPI ID";
                    }
                } else {
                    isBeneficiaryValid = false;
                    resBox.style.color = 'red';
                    resBox.innerText = currentMode === 'IMPS' ? "Invalid Account Number" : "Invalid UPI ID";
                    if(data.error) resBox.innerText = data.error;
                }
            } catch (e) {
                console.log(e);
            }
        }

        // Transfer Funds Logic
        async function submitTransfer() {
            const amount = parseFloat(document.getElementById('inputAmount').value);
            const identifier = document.getElementById('inputIdentifier').value;
            const note = document.getElementById('inputNote').value;

            // Validation
            if (!isBeneficiaryValid) {
                alert("Please enter a valid " + (currentMode === 'IMPS' ? "Account Number" : "UPI ID"));
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                alert("Please enter a valid positive amount");
                return;
            }
            if (amount > currentBalance) {
                alert("Insufficient Balance! Max: " + currentBalance);
                return;
            }

            // API Call
            if(!confirm(`Transfer ₹${amount} to ${identifier}?`)) return;

            try {
                const response = await fetch('/api/transferFunds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: currentMode,
                        identifier: identifier,
                        amount: amount,
                        note: note
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert("Success: " + data.message);
                    location.reload(); // Reload to update balance
                } else {
                    alert("Failed: " + data.error);
                }
            } catch (e) {
                alert("Server Connection Error, Please try again!");
            }
        }

        // Transaction History Logic
        async function loadTransactions() {
            const tbody = document.getElementById('transBody');
            const msg = document.getElementById('noTransMsg');

            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Loading...</td></tr>';
            msg.style.display = 'none';

            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();

                tbody.innerHTML = ''; // Clear loading message

                if (data.length === 0) {
                    msg.style.display = 'block';
                    return;
                }

                data.forEach(t => {
                    // Logic for Debit/Credit Styling
                    const isDebit = t.type === 'DEBIT';
                    const badgeClass = isDebit ? 'badge-debit' : 'badge-credit';
                    const amountColor = isDebit ? '#c92a2a' : '#2b8a3e';
                    const sign = isDebit ? '-' : '+';

                    const row = `
                        <tr>
                            <td style="font-family:monospace; color:#666;">${t.id}</td>
                            <td>${t.date}</td>
                            <td>${t.from}</td>
                            <td>${t.to}</td>
                            <td>${t.mode}</td>
                            <td><span class="badge ${badgeClass}">${t.type}</span></td>
                            <td style="font-weight:bold; color:${amountColor};">${sign} ₹${t.amount.toFixed(2)}</td>
                            <td style="color:#666; font-style:italic;">${t.note || '-'}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:red;">Failed to load history</td></tr>';
            }
        }

        // Update the tab switching logic to auto-load history when clicked
        const originalOpenTab = openTab;
        openTab = function(evt, tabName) {
            originalOpenTab(evt, tabName);
            if (tabName === 'tabHistory') {
                loadTransactions();
            }
            else if (tabName === 'tabAccount') {
                loadAccountInfo();
            }
        };

    </script>
</body>
</html>